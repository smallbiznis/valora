name: GitHub Release

on:
  push:
    # Tag-driven releases only (no branch or SHA releases).
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (vX.Y.Z) to publish"
        required: true
        type: string

permissions:
  # Default to read-only; jobs elevate only where required.
  contents: read

env:
  # Single source of truth for the release tag across jobs.
  RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

jobs:
  build-images:
    name: Build Images
    uses: ./.github/workflows/docker-release.yml
    permissions:
      contents: read
      packages: write
    with:
      tag: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
    secrets: inherit

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build-images
    permissions:
      contents: write

    steps:
      - name: Checkout repository at tag
        uses: actions/checkout@v4
        with:
          # Full history ensures deterministic tag resolution for release notes.
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Resolve release metadata
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          tag="${RELEASE_TAG}"

          # Enforce SemVer tags for auditability and tool compatibility.
          # Relaxed regex to allow pre-release suffixes (e.g., -rc.1)
          if ! [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Invalid tag '${tag}'. Expected vX.Y.Z or vX.Y.Z-rc.N."
            exit 1
          fi

          # Ensure tag exists locally and resolve the exact commit it points to.
          git fetch --tags --force
          if ! git rev-parse --verify "refs/tags/${tag}" >/dev/null; then
            echo "Tag '${tag}' not found."
            exit 1
          fi

          tag_commit="$(git rev-list -n 1 "$tag")"
          prev_tag="$(git describe --tags --abbrev=0 --match "v*.*.*" "${tag_commit}^" 2>/dev/null || true)"

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "version=${tag#v}" >> "$GITHUB_OUTPUT"
          echo "tag_commit=${tag_commit}" >> "$GITHUB_OUTPUT"
          echo "prev_tag=${prev_tag}" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ steps.resolve.outputs.tag }}"
          prev_tag="${{ steps.resolve.outputs.prev_tag }}"
          notes="release_notes.md"

          if [ -n "$prev_tag" ]; then
            range="${prev_tag}..${tag}"
            header="Changes since ${prev_tag}"
          else
            range="${tag}"
            header="Changes"
          fi

          {
            echo "# ${tag}"
            echo ""
            echo "## ${header}"
            git log --no-merges --pretty=format:'- %s (%h)' "${range}"
            if [ -z "$prev_tag" ]; then
              echo ""
              echo ""
              echo "_First release: no previous tag found._"
            fi
            echo ""
            echo ""
            echo "## Source"
            echo ""
            echo "\`${tag}\` -> \`${{ steps.resolve.outputs.tag_commit }}\`"
            echo ""
            echo "## Docker Image"
            echo ""
            echo "ghcr.io/${{ github.repository_owner }}/railzway:${tag}"
          } > "${notes}"

          if [ ! -s "${notes}" ]; then
            echo "Release notes were not generated."
            exit 1
          fi

      - name: Archive source from tag
        id: archive
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ steps.resolve.outputs.tag }}"
          archive="railzway-${tag}.tar.gz"

          # Archive directly from the tag to avoid HEAD ambiguity.
          git archive --format=tar.gz --prefix="railzway-${tag}/" "${tag}" > "${archive}"

          echo "file=${archive}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve.outputs.tag }}
          name: ${{ steps.resolve.outputs.tag }}
          body_path: release_notes.md
          files: ${{ steps.archive.outputs.file }}
          fail_on_unmatched_files: true
